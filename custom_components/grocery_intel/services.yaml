add_receipt:
  name: Add receipt
  description: Add a grocery receipt and update spend totals.
  fields:
    total:
      name: Total
      description: Receipt total amount.
      required: true
      selector:
        number:
          min: 0
          mode: box
          step: 0.01
    date:
      name: Date
      description: ISO date or datetime. Defaults to now in Home Assistant timezone.
      required: false
      selector:
        text:
    store:
      name: Store
      description: Store name.
      required: false
      selector:
        text:
    raw_text:
      name: Raw text
      description: Raw receipt text.
      required: false
      selector:
        text:
    line_items:
      name: Line items
      description: List of line item objects with raw_name and line_total.
      required: false
      selector:
        object:

update_receipt:
  name: Update receipt
  description: Update parsed receipt fields and (optionally) replace line items, then reprocess analytics.
  fields:
    receipt_id:
      name: Receipt ID
      description: Receipt ID to update.
      required: true
      selector:
        text:
    store_name:
      name: Store name
      description: Store/merchant name.
      required: false
      selector:
        text:
    purchased_at:
      name: Purchased at
      description: ISO date or datetime (or common receipt formats). Set to empty to clear.
      required: false
      selector:
        text:
    total:
      name: Total
      description: Receipt total amount.
      required: false
      selector:
        number:
          min: 0
          mode: box
          step: 0.01
    currency:
      name: Currency
      description: Currency symbol (e.g. kr, â‚¬, $). Set to empty to clear.
      required: false
      selector:
        text:
    line_items:
      name: Line items
      description: Replace line items with a list of objects (raw_name, line_total, qty_raw, unit_price_raw).
      required: false
      selector:
        object:
    clear_line_items:
      name: Clear line items
      description: Clear stored line items (and derived observations).
      required: false
      selector:
        boolean:
    reprocess:
      name: Reprocess
      description: Re-run matching/observations after updating.
      required: false
      selector:
        boolean:

undo_activity:
  name: Undo activity
  description: Undo a previous activity (e.g., receipt add/import or extraction completion/failure).
  fields:
    activity_id:
      name: Activity ID
      description: Activity ID to undo.
      required: true
      selector:
        text:

reprocess_receipts:
  name: Reprocess receipts
  description: Re-run matching and observation generation for recent receipts.
  fields:
    receipt_id:
      name: Receipt ID
      description: Reprocess a specific receipt if provided.
      required: false
      selector:
        text:
    limit:
      name: Limit
      description: Max number of receipts to reprocess when no receipt_id is provided.
      required: false
      selector:
        number:
          min: 1
          max: 500
          mode: box
          step: 1

scan_receipts_inbox:
  name: Scan receipts inbox
  description: Scan the receipts inbox path for new files and archive them. Already-processed files are archived with a _duplicate suffix.

run_ocr:
  name: Run OCR
  description: Run extraction for pending receipts or a specific receipt. Uses OCR in heuristic/hybrid mode; triggers LLM file parsing when extractor_mode=llm.
  fields:
    receipt_id:
      name: Receipt ID
      description: Run OCR for a specific receipt if provided.
      required: false
      selector:
        text:
    overwrite:
      name: Overwrite
      description: Overwrite existing values (total/date/store) if enabled.
      required: false
      selector:
        boolean:

reparse_receipts:
  name: Re-parse receipts
  description: Re-parse total/date/store from existing OCR text for recent receipts (no OCR call).
  fields:
    receipt_id:
      name: Receipt ID
      description: Re-parse a specific receipt if provided.
      required: false
      selector:
        text:
    limit:
      name: Limit
      description: Max number of receipts to re-parse when no receipt_id is provided.
      required: false
      selector:
        number:
          min: 1
          max: 500
          mode: box
          step: 1
    overwrite:
      name: Overwrite
      description: Overwrite existing values (total/date/store) if enabled.
      required: false
      selector:
        boolean:

clear_all_data:
  name: Clear all data
  description: Clear all Grocery Intel data (receipts, products, observations, processed file history, and activity log).
  fields:
    confirm:
      name: Confirm
      description: Must be enabled/true to proceed. This action is irreversible.
      required: true
      selector:
        boolean:

run_auto_shopping:
  name: Run auto shopping
  description: Run the daily auto shopping list job now (adds items to the default Home Assistant shopping list).
  fields:
    dry_run:
      name: Dry run
      description: If enabled, computes candidates but does not add items.
      required: false
      selector:
        boolean:

scan_inventory_images_inbox:
  name: Scan inventory images inbox
  description: Scan the inventory images inbox path for new files and archive them. Already-processed files are archived with a _duplicate suffix.

run_inventory_vision:
  name: Run inventory vision
  description: Analyze pending inventory images with a vision-capable LLM to boost probabilistic inventory.
  fields:
    image_id:
      name: Image ID
      description: Inventory image ID to analyze. If omitted, analyzes pending images.
      required: false
      selector:
        text:

reset_stuck_receipts:
  name: Reset stuck receipts
  description: Reset receipts stuck in extraction state (queued/running) back to pending so they can be retried.
  fields:
    older_than_minutes:
      name: Older than (minutes)
      description: Only reset receipts queued/running longer than this. Default 30.
      required: false
      selector:
        number:
          min: 1
          max: 1440
          mode: box
          step: 1

telegram_ingest:
  name: Telegram ingest
  description: Ingest a Telegram attachment into Grocery Intel (receipt or inventory image), optionally auto-detecting type and sending feedback.
  fields:
    chat_id:
      name: Chat ID
      description: Telegram chat ID to reply to (must be allowlisted in options).
      required: true
      selector:
        text:
    file_id:
      name: File ID
      description: Telegram file_id for the attachment (from Home Assistant telegram event payload).
      required: true
      selector:
        text:
    message_id:
      name: Message ID
      description: Telegram message_id to reply to (optional).
      required: false
      selector:
        text:
    filename:
      name: Filename
      description: Override filename when saving (optional).
      required: false
      selector:
        text:
    caption:
      name: Caption
      description: Caption text (used for auto-detect keywords like receipt/inventory, fridge/pantry).
      required: false
      selector:
        text:
    kind:
      name: Kind
      description: Set explicitly to receipt or inventory, or use auto to classify.
      required: false
      default: auto
      selector:
        select:
          options:
            - auto
            - receipt
            - inventory

export_data:
  name: Export data
  description: Export analyzed Grocery Intel data to a JSON file (written to the exports folder path).
  fields:
    scope:
      name: Scope
      description: Export scope. analytics = minimal; debug = includes extraction metadata; full = includes activity log.
      required: false
      default: analytics
      selector:
        select:
          options:
            - analytics
            - debug
            - full
    since:
      name: Since
      description: Optional start date/time filter (ISO, or date-only like 2026-01-01) in Home Assistant local time.
      required: false
      selector:
        text:
    until:
      name: Until
      description: Optional end date/time filter (ISO, or date-only like 2026-12-31) in Home Assistant local time.
      required: false
      selector:
        text:
    include_undated:
      name: Include undated receipts
      description: When filtering by since/until, include receipts without a purchased_at.
      required: false
      default: false
      selector:
        boolean:
    filename:
      name: Filename
      description: Optional filename override (e.g., grocery_intel_export.json). Defaults to a timestamped name.
      required: false
      selector:
        text:

dedupe_stores:
  name: Dedupe stores
  description: Merge duplicate store entities and update receipts to point to canonical store_entity_id values (dry-run by default).
  fields:
    mode:
      name: Mode
      description: "Deduplication mode: hybrid (recommended), strict, or chain_only."
      required: false
      default: hybrid
      selector:
        select:
          options:
            - hybrid
            - strict
            - chain_only
    dry_run:
      name: Dry run
      description: If enabled, computes what would change but does not write to storage.
      required: false
      default: true
      selector:
        boolean:
    delete_orphans:
      name: Delete orphan stores
      description: If enabled, deletes store rows that are no longer referenced by any receipt after merging (in dry_run it reports projected counts).
      required: false
      default: false
      selector:
        boolean:
    max_preview:
      name: Max preview
      description: Max number of merge mappings to include in the activity/persistent notification preview.
      required: false
      default: 20
      selector:
        number:
          min: 0
          max: 200
          mode: box
          step: 1
